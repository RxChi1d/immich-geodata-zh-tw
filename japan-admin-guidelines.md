# 日本行政區顯示規則說明

## 文件目的
- **服務目標**：統一 Immich 反向地理編碼中日本資料的輸出格式，確保與官方 N03 行政區定義與使用者閱讀習慣一致。
- **適用流程**：`JapanGeoDataHandler.extract_from_shapefile` 產生的中介 CSV，以及後續 `convert_to_cities_schema` 匯入的城市資料。

## 欄位對應
- **Country**：固定輸出 `日本`，對應 `COUNTRY_NAME`。
- **admin1**：使用 `N03_001`（都道府縣名稱）。
- **admin2**：依下列分支邏輯產生單一字串，不再拆細。
- **admin3 / admin4**：目前程式固定輸出空字串，僅保留欄位結構。

## 判斷流程
程式會在讀取 Shapefile 後依序產生下列旗標，再組合 `admin2`：

1. **普通市（R1）**
   - 條件：`N03_003` 為空值，`N03_004` 以「市」結尾，且 `N03_005` 為空值。
   - 輸出：`admin2 = N03_004`。
   - 說明：市不受郡管轄，輸出保留簡潔市名。

2. **直轄町 / 村 / 特別區（R2）**
   - 條件：`N03_003` 為空值，`N03_004` 仍有值（多為「町」、「村」或「區」），`N03_005` 為空值，且 `N03_004` 不以「市」結尾。
   - 輸出：`admin2 = N03_004`。
   - 說明：部分離島或特別區（例如東京 23 區）直接隸屬於都道府縣，沒有郡級編制，需保留原名稱。

3. **政令指定都市區（R3）**
   - 條件：`N03_005` 有值，對應新版資料中的區名。
   - 輸出：`admin2 = N03_004`（僅市名），例如「横浜市」。
   - 調整原因：
     - 提升顯示一致性：與主流地圖服務（Google Maps、OpenStreetMap）對政令市地址解析的行為一致，均僅返回「都道府縣＋政令市名」。
     - 降低 Immich 誤判率：當資料顆粒到區層級時，政令市相鄰區的中心點距離過近，易造成定位結果落在錯誤區名。
   - 定位精度保證：各區的獨立記錄與中心點仍保留在資料集中，僅 `admin_2` 欄位統一為市名。
   - 彈性設定：若需恢復「市＋區」顯示，可在 `JapanGeoDataHandler` 類別中將 `SEIREI_SHI_CITY_NAME_ONLY` 常數設為 `False`。

4. **郡轄町 / 村（R4）**
   - 條件：`N03_003` 以「郡」結尾，`N03_004` 為町或村。
   - 預設輸出：`admin2 = N03_004`（僅顯示町/村）。
   - 不加郡案例：若同一都道府縣內該町/村名稱唯一，則維持簡潔模式。例如「新潟県,岩船郡関川村」-> 「新潟県,関川村」。
   - 加郡案例：若同一都道府縣內出現多個郡擁有完全同名的町/村，程式會自動判斷並改為 `admin2 = N03_003 + N03_004`，例如「北海道,古宇郡泊村 vs 北海道,国後郡泊村」。
   - 說明：此規則旨在平衡簡潔性與避免同名混淆的需求。

5. **僅郡名（R5）**
   - 條件：無市區町村名稱 (`N03_004`、`N03_005` 均為空)，僅有 `N03_003`。
   - 輸出：`admin2 = N03_003`。
   - 說明：此情境罕見，多為行政邊界資料不含下層區劃時的後備方案。

## 郡名稱補充策略
- **重複判斷方式**：程式先依「都道府縣 + 郡名 + 町/村名」去重後，再統計同都道府縣內相同的町/村的郡數量；僅在「同一都道府縣的多個郡擁有完全相同的町/村名」時，才會啟用郡名前綴。
- **避免誤觸案例**：
  - 「釧路市」與「釧路町」雖同名，但一個為市、一個為町，字尾不同，因此不會錯誤套用郡名。「北海道,釧路市」->「北海道,釧路市」；「北海道,釧路郡釧路町」->「北海道,釧路町」。

## 資料處理細節
- **座標計算**：以自適應 UTM 區結合 Albers 投影計算中心點，轉回 WGS84 後輸出經緯度，並統一小數位數（預設 8 位）。
- **欄位清理**：`N03_003`、`N03_004`、`N03_005` 會先去除空字串與 `None` 再使用，確保判斷條件一致。
- **排序輸出**：最終 CSV 會按照 `country → admin_1 → admin_2` 排序，以利版本控制與差異比對。

## 參考範例
| 類別 | N03_001 | N03_003 | N03_004 | N03_005 | admin2 輸出 | 備註 |
| --- | --- | --- | --- | --- | --- | --- |
| 普通市 | 北海道 | （空） | 釧路市 | （空） | 釧路市 | 市不屬郡，直接顯示市名 |
| 直轄町/村/特別區 | 東京都 | （空） | 小笠原村 | （空） | 小笠原村 | 離島或特別區由都直接管理，保留原名 |
| 郡轄村（無同名衝突） | 新潟県 | 岩船郡 | 関川村 | （空） | 関川村 | 預設簡潔模式 |
| 郡轄村（同名衝突） | 北海道 | 古宇郡 | 泊村 | （空） | 古宇郡泊村 | 多郡同名時自動補郡 |
| 政令市區 | 神奈川県 | 横浜市 | 横浜市 | 中区 | 横浜市 | 僅顯示市名，保留各區記錄以維持定位精度 |
