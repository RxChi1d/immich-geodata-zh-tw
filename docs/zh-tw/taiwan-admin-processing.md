# 臺灣行政區處理邏輯

> 本文件說明本專案如何處理臺灣地區的地理資訊，是 README 中臺灣優化章節的詳細版本。

## 資料來源

本專案針對臺灣地區的地理資訊處理，以**中華民國國土測繪中心 (NLSC)** 的官方圖資為核心：

- **來源**：[國土測繪中心開放資料平台](https://whgis-nlsc.moi.gov.tw/Opendata/Files.aspx)
- **資料集**：村(里)界 (TWD97經緯度)
- **用途**：作為臺灣地區村里界線及行政區名稱的主要數據源，確保資料的準確性與權威性

透過處理 NLSC 的村里資料，能將地理座標反向解析準確至村里層級，藉此提供更精確的鄉鎮市區及縣市層級資訊。

## 行政區劃層級定義

本專案採用 GeoNames 的行政區劃層級系統，對應臺灣的行政區如下：

- **一級行政區 (Admin1)**：對應臺灣的 **22 個直轄市及省轄縣市**
  - 範例：臺北市、基隆市、彰化縣、南投縣

- **二級行政區 (Admin2)**：對應各縣市下的 **鄉、鎮、市、區**
  - 範例：新北市板橋區、彰化縣彰化市、南投縣埔里鎮

- **三級行政區 (Admin3)**：對應 NLSC 資料中的 **村、里**
  - 範例：臺北市大安區龍安里、新北市板橋區文化里

- **四級行政區 (Admin4)**：目前未使用

## GeoNames 欄位對應

從 NLSC 村里界資料提取時，使用以下欄位對應：

- **Country**：顯示「臺灣」
- **admin_1**：使用 `COUNTYNAME`（縣市名稱）
- **admin_2**：使用 `TOWNNAME`（鄉鎮市區名稱）
- **admin_3**：使用 `VILLNAME`（村里名稱）
- **admin_4**：目前設為空值

## 行政區顯示規則

本專案直接使用 NLSC 官方資料提供的行政區劃資訊，不進行額外的修改或驗證。

### 資料處理方式

- **縣市層級 (admin_1)**：直接讀取 `COUNTYNAME` 欄位
  - 範例：臺北市、新北市、彰化縣

- **鄉鎮市區層級 (admin_2)**：直接讀取 `TOWNNAME` 欄位
  - 範例：板橋區、彰化市、埔里鎮

- **村里層級 (admin_3)**：直接讀取 `VILLNAME` 欄位
  - 範例：龍安里、文化里

> [!NOTE]
> 本專案依賴 NLSC 官方資料的完整性與準確性。NLSC 的村里界資料本身已包含完整的行政區劃資訊（縣市、鄉鎮市區、村里），程式碼直接使用這些官方資料，無需額外的修正或驗證邏輯。

## 資料處理細節

### 座標計算

- 原始資料使用 TWD97 經緯度座標系統（EPSG:4326）
- 為確保中心點計算的準確性，先轉換到投影座標系統 TWD97 / TM2 zone 121（EPSG:3826）
- 在投影座標系統下計算多邊形中心點
- 將中心點轉換回 WGS84（EPSG:4326）後輸出經緯度
- 統一小數位數為 8 位（約 1.1 毫米精度）

> [!NOTE]
> 使用投影座標系統計算中心點可以避免地理座標系統下的距離失真問題，確保中心點位置的準確性。

### 資料清理與輸出

- 過濾無效的座標點（經緯度為 null 的記錄）
- 將所有 object 類型欄位轉換為字串格式，確保資料一致性
- 使用基類共用方法處理排序與標準化輸出

## 資料處理流程

完整的臺灣資料處理流程如下：

```bash
# 1. 下載 NLSC 村里界資料
# 前往 https://whgis-nlsc.moi.gov.tw/Opendata/Files.aspx
# 下載「村(里)界（TWD97經緯度）」資料並解壓縮

# 2. 提取原始資料
uv run python main.py extract --country TW \
  --shapefile geoname_data/VILLAGE_NLSC_XXXXXX/VILLAGE_NLSC_XXXXXX.shp \
  --output meta_data/tw_geodata.csv
```

詳細的開發者指引請參閱 [README.md 的開發者章節](../../README.md#開發者本地資料處理)。

## 範例對照表

以下表格展示臺灣不同行政區類型的實際處理範例：

| 行政區類型 | COUNTYNAME | TOWNNAME | VILLNAME | admin_1 顯示 | admin_2 顯示 | admin_3 顯示 |
|-----------|-----------|----------|----------|-------------|-------------|-------------|
| 直轄市-區 | 臺北市 | 大安區 | 龍安里 | 臺北市 | 大安區 | 龍安里 |
| 直轄市-區 | 新北市 | 板橋區 | 文化里 | 新北市 | 板橋區 | 文化里 |
| 省轄市-區 | 新竹市 | 東區 | 光復里 | 新竹市 | 東區 | 光復里 |
| 縣轄市 | 彰化縣 | 彰化市 | 中山里 | 彰化縣 | 彰化市 | 中山里 |
| 縣轄鎮 | 南投縣 | 埔里鎮 | 南村里 | 南投縣 | 埔里鎮 | 南村里 |
| 縣轄鄉 | 花蓮縣 | 壽豐鄉 | 壽豐村 | 花蓮縣 | 壽豐鄉 | 壽豐村 |

## 參考資料

- [國土測繪中心開放資料平台](https://whgis-nlsc.moi.gov.tw/Opendata/Files.aspx)
- [GeoNames Administrative Division Codes](https://www.geonames.org/export/codes.html)
- [TWD97 座標系統說明](https://www.sunriver.com.tw/grid_tm2.htm)
