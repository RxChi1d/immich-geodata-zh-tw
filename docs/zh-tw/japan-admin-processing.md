# 日本行政區處理邏輯

> 本文件說明本專案如何處理日本地區的地理資訊，是 README 中日本優化章節的詳細版本。

## 資料來源

本專案針對日本地區的地理資訊處理，以**国土数値情報ダウンロードサイト**的官方圖資為核心：

- **來源**：[国土数値情報ダウンロードサービス](https://nlftp.mlit.go.jp/ksj/)
- **資料集**：行政区域データ（世界測地系）
- **用途**：作為日本地區行政區邊界與名稱的主要數據源，確保資料的準確性與權威性

透過處理国土数値情報的行政區資料，確保 Immich 中顯示的日本地名保持日文原名（漢字+假名），符合臺灣使用者的閱讀習慣。

## 行政區劃層級定義

本專案採用 GeoNames 的行政區劃層級系統，對應日本的行政區如下：

- **一級行政區 (Admin1)**：對應日本的 **47 個都道府縣**
  - 範例：東京都、北海道、神奈川県

- **二級行政區 (Admin2)**：對應各都道府縣下的 **市、區、町、村**
  - 範例：横浜市、渋谷区、鎌倉市
  - 根據不同類型的行政區，顯示方式有所不同（詳見下方規則）

- **三級行政區 (Admin3)**：僅用於 **政令指定都市的區名**
  - 當 `SEIREI_SHI_CITY_NAME_ONLY = True` 時，admin_2 僅顯示市名（如「横浜市」），admin_3 填入區名（如「中区」）
  - 其他行政區類型的 admin_3 為空

- **四級行政區 (Admin4)**：保持空白（無對應資料）

## GeoNames 欄位對應

從国土数値情報資料提取時，使用以下欄位對應：

- **Country**：顯示「日本」
- **admin_1**：使用 `N03_001`（都道府縣名稱）
- **admin_2**：根據行政區類型決定顯示內容（詳見下方規則）
- **admin_3**：僅政令市在 `SEIREI_SHI_CITY_NAME_ONLY = True` 時使用 `N03_005`（區名）
- **admin_4**：設為空值

## 行政區顯示規則

本專案根據日本行政區的不同類型，採用最適合的顯示方式：

### 1. 普通市

- **適用情況**：不受郡管轄的市（`N03_003` 為空，`N03_004` 以「市」結尾）
- **顯示方式**：僅顯示市名
- **範例**：
  - 北海道 → 釧路市

### 2. 直轄町村與特別區

- **適用情況**：直接隸屬於都道府縣的町、村或特別區（`N03_003` 為空，`N03_004` 不以「市」結尾）
- **顯示方式**：僅顯示町村或區名
- **範例**：
  - 東京都 → 小笠原村（離島）
  - 東京都 → 渋谷区（特別區）

> [!NOTE]
> 東京都的 23 個特別區（千代田区、港区等）直接隸屬於東京都，不受其他行政區管轄。

### 3. 政令指定都市

- **適用情況**：政令指定都市的各區（`N03_005` 有值）
- **顯示方式**：admin_2 僅顯示市名，admin_3 填入區名
- **設計理由**：
  - **提升顯示一致性**：與主流地圖服務（Google Maps、OpenStreetMap）的行為一致，均僅返回「都道府縣＋政令市名」
  - **降低誤判率**：政令市相鄰區的中心點距離過近，容易造成定位結果落在錯誤的區名
  - **保留完整資訊**：各區的獨立記錄、中心點與區名（admin_3）均保留在資料集中
- **範例**：
  - 神奈川県, 横浜市, 中区 → admin_2=「横浜市」, admin_3=「中区」

> [!NOTE]
> 若需恢復「市＋區」顯示在 admin_2（例如「横浜市中区」），可在 `JapanGeoDataHandler` 類別中將 `SEIREI_SHI_CITY_NAME_ONLY` 常數設為 `False`。此時 admin_3 將為空。

### 4. 郡轄町村

- **適用情況**：受郡管轄的町或村（`N03_003` 以「郡」結尾）
- **顯示方式**：根據是否有同名衝突決定
  - **無同名衝突**：僅顯示町村名（簡潔模式）
  - **有同名衝突**：顯示「郡名＋町村名」
- **範例**：
  - 新潟県, 岩船郡, 関川村 → 顯示「関川村」（簡潔模式）
  - 北海道, 古宇郡, 泊村 → 顯示「古宇郡泊村」（避免與国後郡泊村混淆）

> [!NOTE]
> 本專案會自動檢測同一都道府縣內是否有多個郡擁有相同的町村名稱。僅在發現同名衝突時，才會加上郡名前綴。

**同名判斷邏輯**：
- 「釧路市」與「釧路町」**不會**被視為同名（一個是市、一個是町）
- 「古宇郡泊村」與「国後郡泊村」**會**被視為同名（都是泊村）

### 5. 僅郡名

- **適用情況**：無市區町村名稱（`N03_004`、`N03_005` 均為空），僅有郡名
- **顯示方式**：顯示郡名
- **說明**：此情境罕見，多為行政邊界資料不含下層區劃時的後備方案

## 資料處理細節

### 座標計算

- 使用自適應 UTM 區結合 Albers 投影計算多邊形中心點
- 轉換回 WGS84 座標後輸出經緯度
- 統一小數位數為 8 位

### 資料清理

- 自動過濾 `N03_003`、`N03_004`、`N03_005` 欄位中的空字串與 `None` 值確保判斷條件的一致性

### 排序輸出

- 最終 CSV 按照 `country → admin_1 → admin_2` 排序
- 便於版本控制與差異比對

## 資料處理流程

完整的日本資料處理流程如下：

```bash
# 1. 下載国土数値情報資料
# 前往 https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N03-2025.html
# 下載「行政区域データ（世界測地系）」並解壓縮

# 2. 提取原始資料
uv run python main.py extract --country JP \
  --shapefile geoname_data/N03-20250101_GML/N03-20250101.shp \
  --output meta_data/jp_geodata.csv
```

詳細的開發者指引請參閱 [README.md 的開發者章節](../../README.md#開發者本地資料處理)。

## 範例對照表

以下表格展示不同行政區類型的實際處理範例：

| 行政區類型 | N03_001 | N03_003 | N03_004 | N03_005 | admin_2 | admin_3 | 說明 |
|-----------|---------|---------|---------|---------|---------|---------|------|
| 普通市 | 北海道 | （空） | 釧路市 | （空） | 釧路市 | （空） | 市不屬郡，直接顯示市名 |
| 直轄町村 | 東京都 | （空） | 小笠原村 | （空） | 小笠原村 | （空） | 離島由都直接管理 |
| 特別區 | 東京都 | （空） | 渋谷区 | （空） | 渋谷区 | （空） | 東京都 23 區 |
| 政令市區 | 神奈川県 | 横浜市 | 横浜市 | 中区 | 横浜市 | 中区 | admin_2 顯示市名，admin_3 保留區名 |
| 郡轄村（無同名） | 新潟県 | 岩船郡 | 関川村 | （空） | 関川村 | （空） | 簡潔模式 |
| 郡轄村（有同名） | 北海道 | 古宇郡 | 泊村 | （空） | 古宇郡泊村 | （空） | 多郡同名時自動補郡名 |

## 參考資料

- [国土数値情報ダウンロードサービス](https://nlftp.mlit.go.jp/ksj/)
- [GeoNames Administrative Division Codes](https://www.geonames.org/export/codes.html)
