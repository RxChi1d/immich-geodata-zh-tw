# 南韓行政區處理指引

本文檔說明南韓地理資料的處理策略、行政區系統、翻譯方法與技術實作細節。

## 目錄

- [行政區層級說明](#行政區層級說明)
- [廣域市/道類型介紹](#廣域市道類型介紹)
- [中心點計算方法](#中心點計算方法)
- [繁體中文翻譯策略](#繁體中文翻譯策略)
  - [翻譯層級與優先順序](#翻譯層級與優先順序)
  - [Wikidata 翻譯流程](#wikidata-翻譯流程)
  - [快取機制](#快取機制)
- [Admin 2 正規化與拆分](#admin-2-正規化與拆分)
- [特殊行政區處理](#特殊行政區處理)
  - [世宗特別自治市](#世宗特別自治市)
- [同名問題處理](#同名問題處理)
- [資料來源](#資料來源)

---

## 行政區層級說明

南韓採用三級行政區系統（不包含國家層級）：

| 層級 | 韓文名稱 | 類型 | 數量 | 對應欄位 |
|------|----------|------|------|----------|
| **Admin 1** | 廣域市/道 | 광역자치단체 | 17 個 | `sidonm` |
| **Admin 2** | 市/區/郡 | 기초자치단체 | ~250 個 | `sggnm` |
| **Admin 3** | 洞/邑/面 | 행정동/법정동 | ~3,500 個 | `admin_3` (解析自 `adm_nm`) |

### Admin 1 分類統計

17 個廣域市/道包含以下類型：

- **特別市**（특별시）：1 個 - 首爾
- **廣域市**（광역시）：6 個 - 釜山、大邱、仁川、光州、大田、蔚山
- **特別自治市**（특별자치시）：1 個 - 世宗
- **道**（도）：6 個 - 京畿道、忠清北道、忠清南道、慶尚北道、慶尚南道、全羅南道
- **特別自治道**（특별자치도）：3 個 - 江原特別自治道、全北特別自治道、濟州特別自治道

### Admin 2 類型

基礎自治團體（기초자치단체）主要分為：

- **市**（시）：主要城市地區
- **區**（구）：廣域市下的行政區
- **郡**（군）：農村地區

### Admin 3 類型

- **洞**（동）：城市地區的基層行政單位
- **邑**（읍）：城鎮地區
- **面**（면）：農村地區

---

## 廣域市/道類型介紹

南韓的 17 個廣域市/道採用不同的命名規則，在翻譯時需考慮臺灣使用者的習慣：

### 命名規則

1. **特別市/廣域市/特別自治市**：去除後綴，使用簡稱
   - 範例：서울특별시 → 首爾、부산광역시 → 釜山

2. **道/特別自治道**：視情況保留或去除「道」後綴
   - 傳統道級行政區保留「道」：경기도 → 京畿道
   - 特別自治道去除後綴：제주특별자치도 → 濟州

---

## 中心點計算方法

### 挑戰

南韓位於東經 124°～132°，橫跨 **UTM 51N** 和 **UTM 52N** 兩個區域。使用固定 UTM 區計算中心點會導致橫跨邊界的行政區產生嚴重誤差。

### 解決方案

採用**動態 UTM 區選擇結合 Albers 投影**的方法：

1. **Albers 等面積投影**：計算多邊形的準確幾何中心點經度
2. **動態 UTM 區判定**：根據中心點經度選擇適當的 UTM 區（51N 或 52N）
3. **UTM 投影計算**：在各自的 UTM 區中計算最終中心點座標
4. **向量化處理**：同一 UTM 區內的幾何體批次處理，提升效能

---

## 繁體中文翻譯策略

### 翻譯層級與優先順序

南韓地理資料的翻譯採用分層策略，平衡翻譯品質與 API 請求效率：

| 層級 | 翻譯方法 | 數量 | API 請求 |
|------|----------|------|----------|
| **Admin 1** | 內建對照表 + Wikidata QID | 17 | ~17 次 |
| **Admin 2** | Wikidata 批次翻譯 | ~250 | ~250 次 |
| **Admin 2（世宗市）** | **手動對照表** | 24 | **0 次** |
| **Admin 3** | 保留韓文原文 | ~3,500 | 0 次 |

> [!NOTE]
> 世宗特別自治市的 Admin 2 採用手動對照表，完全跳過 Wikidata 查詢。詳細原因見[世宗市手動對照表](#2-手動對照表翻譯)。

**設計理由**：

1. **Admin 1**：使用內建對照表提供簡潔名稱（如「首爾」而非「首爾特別市」），但仍取得 QID 供 Admin 2 驗證
2. **Admin 2**：使用 Wikidata 翻譯，數量適中（~250 個）
3. **Admin 2（世宗市）**：使用手動對照表，確保 100% 繁體中文覆蓋率
4. **Admin 3**：保留韓文原文，避免 3,500+ 次 API 請求，且對使用者體驗影響較小

### Admin 1 翻譯方法

使用**內建對照表**提供臺灣慣用的簡潔名稱，而非 Wikidata 的官方正式名稱。對照表涵蓋全部 17 個廣域市/道，範例：

- 서울특별시 → 首爾（而非「首爾特別市」）
- 부산광역시 → 釜山（而非「釜山廣域市」）
- 경기도 → 京畿道（保留「道」）
- 제주특별자치도 → 濟州（去除「特別自治道」）

### Wikidata 翻譯流程

`WikidataTranslator` 提供通用的地名翻譯功能，支援任意來源/目標語言：

#### 翻譯流程圖

```
1. 搜尋 Wikidata
   ↓ (wbsearchentities API)
   候選 QID 列表 ["Q41164", "Q50275215", ...]

2. P131 驗證（如果提供父級 QID）
   ↓ (SPARQL ASK query)
   選擇符合 P131 關係的 QID

3. 取得多語言標籤
   ↓ (wbgetentities API)
   {"ko": "제주특별자치도", "zh-tw": "濟州特別自治道", ...}

4. 選擇最佳翻譯（回退策略）
   ↓
   zh-TW → zh-Hant → zh（OpenCC 轉繁體）→ en → ko → 原文
```

**註**：`batch_translate()` 使用批次 API 查詢技術（每批最多 50 個 QID）減少請求次數。

#### 回退策略

翻譯時依序嘗試以下語言來源，直到找到可用的翻譯：

1. **zh-TW**（繁體中文-台灣）
2. **zh-Hant**（繁體中文）
3. **zh**（簡體中文，透過 OpenCC 轉繁體）
4. **en**（英文）
5. **ko**（韓文原文）
6. **原始名稱**（若所有來源皆失敗）

#### P131 驗證機制

使用 Wikidata 的 P131（位於行政區）屬性驗證候選 QID 是否屬於正確的上級行政區，避免選擇同名但不同地區的實體。

**範例**：翻譯「江南區」時，驗證候選 QID 是否位於「首爾」之內，避免誤選其他城市的同名行政區。

### 快取機制

為減少重複的 API 請求，系統使用分層快取結構：

- **翻譯結果快取**：儲存最終翻譯與 QID
- **搜尋結果快取**：儲存 Wikidata 搜尋的候選 QID
- **標籤快取**：儲存各 QID 的多語言標籤
- **P131 驗證快取**：儲存已驗證的行政區關係

快取檔案位於 `geoname_data/KR_wikidata_cache.json`，支援版本遷移與自動更新。

---

## Admin 2 正規化與拆分

### 背景

部分城市在 `sggnm` 欄位中寫成「`<市名>시<區名>구`」或「`<市名>시<郡名>군`」，例如「성남시분당구」、「고양시덕양구」。這種合併寫法帶來兩個問題：

1. Wikidata 的實際條目是單獨的區／郡名稱（如 `분당구`），若帶著整串文字去查會回退原文。
2. Immich 顯示層級時會把洞/邑/面與「市＋區」放在同一欄位，導致地名結構混亂。

### 處理流程

`SouthKoreaGeoDataHandler` 會在翻譯前對所有記錄進行正規化：

1. **偵測規則**：使用正則 `^(?P<city>.+?시)(?P<district>.+?(?:구|군))$`，只要同時存在 `시` 與末尾 `구/군` 就視為合併名稱。
2. **拆分動作**：
   - `sggnm` 改為純粹的市級名稱（`성남시`）。
   - 拆出的區／郡名稱填入新的 `admin_3`，作為真正的 Admin 2 顯示文字（`분당구`）。
   - 原本解析的洞/邑/面則下移到 `admin_4`，確保不遺失細節（`태평3동`）。
3. **日誌觀測**：若偵測到合併名稱，log 會顯示拆分筆數，方便驗證資料來源是否異常。

### 成果

- 翻譯器只需處理單一層級的區／郡名稱，Wikidata 匹配率大幅提升。
- CSV 最終呈現為「京畿道 → 盆唐區 → 태평3洞」，Immich 使用者可以清楚辨識每個層級。
- 任何原始 Admin 3 內容仍可在 `admin_4` 查詢，便於除錯與後續資料擴充。

---

## 特殊行政區處理

### 世宗特別自治市

世宗特別自治市（세종특별자치시）是南韓唯一的**單層級特別自治市**，行政結構與其他廣域市不同：

```
標準結構：廣域市/道 → 市/區/郡 → 洞/邑/面
世宗結構：世宗特別自治市 → 洞/邑/面 ← 沒有中間層級！
```

### 原始資料問題

在原始 shapefile 資料中，`sggnm` 欄位對應標準的 Admin 2 層級（市/區/郡）。然而世宗因為缺少中間層級，該欄位被錯誤填入政府機構名稱：

- `세종특별자치시광역자치의회`（世宗特別自治市廣域自治議會）
- `세종특별자치시청`（世宗特別自治市廳）

這些是**議會或行政機關**，而非地理行政區。若直接使用，會導致 Immich 顯示「世宗 > 世宗特別自治市廣域自治議會」，而非「世宗 > 鳥致院邑」等正確的洞/邑/面名稱。

### 處理方式

本專案採用**三階段處理機制**解決世宗的特殊結構與翻譯問題：

#### 1. 行政層級正規化

在翻譯階段之前，先將世宗記錄的洞/邑/面名稱從 Admin 3 提升至 Admin 2，以符合其單層級結構。處理邏輯如下：

- **檢測條件**：識別世宗記錄中 `sggnm` 欄位填入非行政區名稱的情況（不以邑/面/洞結尾）
- **正規化動作**：將 Admin 3 的洞/邑/面名稱移至 Admin 2，清空 Admin 3

**範例**：
- 處理前：`世宗特別自治市` → `世宗特別自治市廳` → `대평동`
- 處理後：`世宗特別自治市` → `대평동` → (空)

#### 2. 手動對照表翻譯

**背景**：世宗市於 2012 年成立，許多新設立的洞（如「寶藍洞」、「多情洞」）在 Wikidata 缺少繁體中文標籤。若使用 Wikidata 翻譯，會回退至英文羅馬拼音（如 `Boram-dong`）或保留韓文原文。

**解決方案**：建立韓文→繁體中文手動對照表，涵蓋世宗市全部 24 個 Admin 2 地名。

##### 對照表設計

- **格式**：韓文原文 → 繁體中文
- **涵蓋範圍**：24 筆地名
  - 11 筆必須翻譯（Wikidata 無 zh-tw 標籤）
  - 13 筆可選翻譯（避免重複查詢，提升效能）
- **位置**：`core/geodata/south_korea.py` 中的 `SEJONG_ADMIN2_MAP`

##### 對照表範例

```python
SEJONG_ADMIN2_MAP = {
    # 8 個洞 (Dong) - Wikidata 無 zh-tw 標籤
    "보람동": "寶藍洞",
    "대평동": "大坪洞",
    "다정동": "多情洞",
    "도담동": "嶋潭洞",
    "고운동": "高運洞",
    "종촌동": "鍾村洞",
    "새롬동": "新羅洞",
    "소담동": "素潭洞",

    # 3 個韓文地名 - CSV 中仍為韓文
    "어진동": "御珍洞",
    "반곡동": "盤谷洞",
    "해밀동": "海密洞",

    # 以下為可選翻譯（已可通過 Wikidata 翻譯，但直接使用對照表提升效能）
    "조치원읍": "鳥致院邑",
    "부강면": "芙江面",
    "장군면": "將軍面",
    # ... 其他地名
}
```

##### 翻譯流程

```
世宗市 Admin 2 翻譯流程：

1. 檢測是否為世宗特別自治市
   ↓ (admin1_ko_name == "세종특별자치시")

2. 查詢手動對照表
   ↓ (SEJONG_ADMIN2_MAP)

3. 直接返回繁體中文
   ↓ (完全跳過 Wikidata 查詢)

   結果：보람동 → 寶藍洞
```

**翻譯成果對比**：

| 原始韓文 | Wikidata 翻譯（實作前） | 手動對照表（實作後） |
|---------|----------------------|-------------------|
| 보람동 | Boram-dong ❌ | 寶藍洞 ✅ |
| 대평동 | Daepyeong-dong ❌ | 大坪洞 ✅ |
| 어진동 | 어진동 ❌ | 御珍洞 ✅ |
| 반곡동 | 반곡동 ❌ | 盤谷洞 ✅ |
| 조치원읍 | 鳥致院邑 ✅ | 鳥致院邑 ✅ |

#### 3. Wikidata 候選過濾

在翻譯階段，透過候選過濾機制排除政府機構類實體，確保翻譯結果為真實的行政區名稱。過濾器會檢查 Wikidata 候選實體的標籤，排除包含以下特徵的項目：

- **議會機構**：議會、council、assembly 等
- **行政機關**：市廳、區公所、郡廳、道廳、教育廳、government 等（僅匹配完整詞彙，避免單字觸發）

此機制可防止「세종특별자치시청」被翻譯為「世宗特別自治市廳」，確保僅選擇地理行政區實體。

候選過濾會先批次抓取候選的多語言標籤與 P31，再以完整詞彙（如 `시청`、`도청`、`군청`）做比對，避免像「清道郡」「青松郡」這類合法行政區因單字（`청`）而被誤刪。

> [!NOTE]
> 經過三階段處理後，世宗記錄的 Admin 2 會顯示洞/邑/面的繁體中文名稱（如「鳥致院邑」、「燕岐面」、「寶藍洞」），Admin 3 保持空白。這樣 Immich 就能正確顯示「世宗 > 鳥致院邑」等地理資訊。

---

## 同名問題處理

### Admin 2 層級

南韓有 7 個重複的 Admin 2 名稱，但在各自的 Admin 1 層級下是唯一的：

| 名稱 | 出現次數 | 範例 |
|------|----------|------|
| 중구 (中區) | 2 | 首爾中區、仁川中區 |
| 남구 (南區) | 3 | 釜山南區、大邱南區、光州南區 |
| 북구 (北區) | 3 | 大邱北區、光州北區、蔚山北區 |

**處理方式**：透過 P131 驗證機制，確保選擇正確的 Admin 2（例如：「中區」必須位於「首爾」之內）。

### Admin 3 層級

約 239 個重複的 Admin 3 名稱，但不影響 Immich 顯示：

**原因**：
- Immich 的地理資訊顯示通常只到 Admin 2 層級
- Admin 3 主要用於精確定位，而非顯示

**策略**：保留韓文原文，不進行翻譯。

---

## 資料來源

### 主要資料來源

**admdongkor**
- 專案：https://github.com/vuski/admdongkor
- 描述：南韓行政區邊界資料（GeoJSON 格式）
- 授權：MIT License
- 用途：提供南韓三級行政區的邊界與名稱資料

### 翻譯資料來源

**Wikidata**
- API：https://www.wikidata.org/w/api.php
- 查詢：https://query.wikidata.org/sparql
- 授權：CC0 1.0 Universal (Public Domain)
- 用途：提供多語言地名翻譯與 P131 關係驗證

**中文維基百科**
- API：https://zh.wikipedia.org/w/api.php
- 用途：簡繁轉換（converttitles API）

**OpenCC (Open Chinese Convert)**
- 專案：https://github.com/BYVoid/OpenCC
- 用途：簡體中文轉繁體中文

---

**最後更新**：2025-11-10
**狀態**：已完成 Wikidata 翻譯整合、世宗特別自治市特殊處理與手動對照表翻譯（100% 繁體中文覆蓋率）
