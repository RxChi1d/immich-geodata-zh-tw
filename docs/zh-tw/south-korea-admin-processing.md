# 南韓行政區處理指引

本文檔說明南韓地理資料的處理策略、行政區系統、翻譯方法與技術實作細節。

## 目錄

- [行政區層級說明](#行政區層級說明)
- [廣域市/道類型介紹](#廣域市道類型介紹)
- [中心點計算方法](#中心點計算方法)
- [繁體中文翻譯策略](#繁體中文翻譯策略)
  - [翻譯層級與優先順序](#翻譯層級與優先順序)
  - [WikidataTranslator 使用配置](#wikidatatranslator-使用配置)
- [資料正規化](#資料正規化)
  - [市區合併名稱拆分](#市區合併名稱拆分)
  - [同名地名處理](#同名地名處理)
- [世宗特別自治市特殊處理](#世宗特別自治市特殊處理)
- [資料來源](#資料來源)

---

## 行政區層級說明

南韓採用三級行政區系統（不包含國家層級）：

| 層級 | 韓文名稱 | 類型 | 數量 | 對應欄位 |
|------|----------|------|------|----------|
| **Admin 1** | 廣域市/道 | 광역자치단체 | 17 個 | `sidonm` |
| **Admin 2** | 市/區/郡 | 기초자치단체 | ~250 個 | `sggnm` |
| **Admin 3** | 洞/邑/面 | 행정동/법정동 | ~3,500 個 | 解析自 `adm_nm` |
| **Admin 4** | 原始 Admin 3 | - | 僅市區拆分時 | 保留原始資料用 |

> **說明**：Admin 4 僅在市區拆分時使用（如「성남시분당구」拆分為「성남시」+「분당구」），用於保留原始 Admin 3 資料。此欄位對 Immich 反向地理解析無作用，僅供資料完整性與除錯使用。

### Admin 1 分類統計

17 個廣域市/道包含以下類型：

- **特別市**（특별시）：1 個 - 首爾
- **廣域市**（광역시）：6 個 - 釜山、大邱、仁川、光州、大田、蔚山
- **特別自治市**（특별자치시）：1 個 - 世宗
- **道**（도）：6 個 - 京畿道、忠清北道、忠清南道、慶尚北道、慶尚南道、全羅南道
- **特別自治道**（특별자치도）：3 個 - 江原特別自治道、全北特別自治道、濟州特別自治道

### Admin 2 類型

基礎自治團體（기초자치단체）主要分為：

- **市**（시）：主要城市地區
- **區**（구）：廣域市下的行政區
- **郡**（군）：農村地區

### Admin 3 類型

- **洞**（동）：城市地區的基層行政單位
- **邑**（읍）：城鎮地區
- **面**（면）：農村地區

---

## 廣域市/道類型介紹

南韓的 17 個廣域市/道採用不同的命名規則，在翻譯時需考慮臺灣使用者的習慣：

### 命名規則

1. **特別市/廣域市/特別自治市**：去除後綴，使用簡稱
   - 範例：서울특별시 → 首爾、부산광역시 → 釜山

2. **道/特別自治道**：視情況保留或去除「道」後綴
   - 傳統道級行政區保留「道」：경기도 → 京畿道
   - 特別自治道去除後綴：제주특별자치도 → 濟州

---

## 中心點計算方法

### 挑戰與解決方案

南韓橫跨 UTM 51N 和 52N（東經 124°～132°），固定 UTM 區會導致邊界行政區產生嚴重誤差。

**採用動態 UTM 區選擇結合 Albers 投影**：

1. **Albers 等面積投影**：計算多邊形的準確幾何中心點經度
2. **動態 UTM 區判定**：根據中心點經度選擇適當的 UTM 區（51N 或 52N）
3. **UTM 投影計算**：在各自的 UTM 區中計算最終中心點座標
4. **向量化處理**：同一 UTM 區內的幾何體批次處理，提升效能

---

## 繁體中文翻譯策略

### 翻譯層級與優先順序

南韓地理資料的翻譯採用分層策略，平衡翻譯品質與 API 請求效率：

| 層級 | 翻譯方法 | 數量 | API 請求 |
|------|----------|------|----------|
| **Admin 1** | 內建對照表 + Wikidata QID | 17 | ~17 次 |
| **Admin 2** | Wikidata 批次翻譯 | ~250 | ~250 次 |
| **Admin 2（世宗市）** | **手動對照表** | 24 | **0 次** |
| **Admin 3** | 保留韓文原文 | ~3,500 | 0 次 |

> [!NOTE]
> 世宗特別自治市的 Admin 2 採用手動對照表，完全跳過 Wikidata 查詢。詳細原因見[世宗市手動對照表](#2-手動對照表翻譯)。

**設計理由**：

1. **Admin 1**：使用內建對照表提供簡潔名稱（如「首爾」而非「首爾特別市」），但仍取得 QID 供 Admin 2 驗證
2. **Admin 2**：使用 Wikidata 翻譯，數量適中（~250 個）
3. **Admin 2（世宗市）**：使用手動對照表，確保 100% 繁體中文覆蓋率
4. **Admin 3**：保留韓文原文，避免 3,500+ 次 API 請求，且對使用者體驗影響較小

### Admin 1 翻譯方法

使用**內建對照表**提供臺灣慣用簡稱（非 Wikidata 官方名稱）。涵蓋全部 17 個廣域市/道：

- 서울특별시 → 首爾（非「首爾特別市」）
- 부산광역시 → 釜山（非「釜山廣域市」）
- 경기도 → 京畿道（保留「道」）
- 제주특별자치도 → 濟州（去除後綴）

### WikidataTranslator 使用配置

本專案使用 `WikidataTranslator` 進行地名翻譯。關於翻譯器的完整功能說明（搜尋、P131 驗證、批次查詢、快取機制等），請參考 WikidataTranslator 文檔。

#### 初始化參數

```python
translator = WikidataTranslator(
    source_lang="ko",              # 來源語言：韓文
    target_lang="zh-tw",           # 目標語言：繁體中文-臺灣
    fallback_langs=["zh-hant", "zh", "en", "ko"],  # 回退語言順序
    cache_path="geoname_data/KR_wikidata_cache.json",
    use_opencc=True                # 啟用簡轉繁
)
```

**回退策略**：翻譯時依序嘗試以下語言來源

1. zh-TW（繁體中文-臺灣）
2. zh-Hant（繁體中文）
3. zh（簡體中文，透過 OpenCC 轉繁體）
4. en（英文）
5. ko（韓文原文）
6. 原始名稱（所有來源皆失敗）

#### 候選過濾配置

在翻譯 Admin 2（市/區/郡）時，使用候選過濾機制排除政府機構類實體，確保翻譯結果為真實行政區名稱。

**過濾規則**：

檢查 Wikidata 候選實體的標籤，排除包含以下關鍵字的項目：

- **議會機構**：의회、議會、council、assembly、委員會、legislature
- **行政機關**：시청、구청、군청、도청、교육청、廳、government

**設計考量**：

- 使用完整詞彙匹配（如 `시청`、`도청`、`군청`），避免單字誤判
- 防止將政府機構誤判為行政區（例如「세종특별자치시청」不應被翻譯為行政區）
- 保留合法行政區（例如「清道郡」不會因「청」字被誤刪）

> [!NOTE]
> 此過濾器僅用於一般地區的 Admin 2 翻譯。世宗特別自治市完全使用手動對照表，不經過 Wikidata 翻譯流程，因此不使用此過濾器。

---

## 資料正規化

本章節說明南韓地理資料的通用正規化處理，適用於全國大部分地區。

### 市區合併名稱拆分

部分城市在 `sggnm` 欄位中採用合併寫法「`<市名>시<區名>구`」（例如「성남시분당구」），造成兩個問題：

1. **翻譯困難**：Wikidata 條目為單獨區名（`분당구`），合併名稱查詢失敗
2. **顯示混亂**：Immich 將市區合併名稱與洞/邑/面放在同一層級

**處理邏輯**：

1. **偵測**：使用正則表達式 `^(?P<city>.+?시)(?P<district>.+?(?:구|군))$` 識別合併名稱
2. **拆分**：
   - `sggnm` → 市級名稱（`성남시`）
   - `admin_3` → 區/郡名稱（`분당구`）
   - `admin_4` → 原始 Admin 3（`태평3동`）
3. **記錄**：日誌顯示拆分筆數供驗證

**效果**：
- Wikidata 匹配率提升
- 層級結構清晰：京畿道 → 盆唐區 → 태평3洞
- 原始資料保留於 `admin_4`

### 同名地名處理

南韓有多個重複的行政區名稱，需要透過 P131 驗證確保選擇正確實體。

#### Admin 2 層級

7 個重複名稱，但在各自 Admin 1 下唯一：

| 名稱 | 出現次數 | 範例 |
|------|----------|------|
| 중구（中區） | 2 | 首爾中區、仁川中區 |
| 남구（南區） | 3 | 釜山南區、大邱南區、光州南區 |
| 북구（北區） | 3 | 大邱北區、光州北區、蔚山北區 |

**處理**：透過 P131 驗證確保選擇正確 Admin 2（例如「中區」必須位於「首爾」之內）。

#### Admin 3 層級

約 239 個重複名稱，不影響 Immich 顯示（通常僅顯示至 Admin 2）。

**策略**：保留韓文原文，不翻譯。

### 消歧義括號處理

部分地名在 Wikidata 中帶有消歧義括號（如「東區 (光州)」），但在本專案的資料結構中，`admin_1` 已經標明父級地區，因此 `admin_2` 不需要重複標註。

#### 光州特殊處理

光州的東區和西區在 Wikidata 的繁體中文標籤中帶有消歧義標記：

- `동구` → 東區 (光州)
- `서구` → 西區 (光州)

**問題**：
- 其他城市（釜山、大邱、仁川、大田、蔚山）的同名區域都沒有括號
- 造成命名不一致
- Immich 顯示時出現冗餘資訊：「光州 > 東區 (光州)」

**處理邏輯**：

在翻譯完成後，針對光州的 Admin 2 記錄移除結尾的消歧義括號：

```python
# 僅處理光州（광주광역시）的記錄
gwangju_parent = "광주광역시"
df = df.with_columns(
    pl.when(pl.col("sidonm") == gwangju_parent)
    .then(pl.col("chinese_admin_2").str.replace_all(r"\s*\([^)]+\)\s*$", ""))
    .otherwise(pl.col("chinese_admin_2"))
    .alias("chinese_admin_2")
)
```

**效果**：

| 處理前 | 處理後 |
|--------|--------|
| 光州 > 東區 (光州) | 光州 > 東區 ✅ |
| 光州 > 西區 (光州) | 光州 > 西區 ✅ |
| 釜山 > 東區 | 釜山 > 東區（不受影響）|

> [!NOTE]
> 此處理僅針對光州，確保精確控制。未來如發現其他城市有類似問題，可擴充處理邏輯。

---

## 世宗特別自治市特殊處理

世宗特別自治市（세종특별자치시）是南韓唯一的**單層級特別自治市**，行政結構與其他廣域市不同，需要專門的處理流程。此處理方式可作為其他國家類似結構的參考。

**結構差異**：

```
標準結構：廣域市/道 → 市/區/郡 → 洞/邑/面
世宗結構：世宗特別自治市 → 洞/邑/面 ← 沒有中間層級！
```

### 資料問題

原始 shapefile 的 `sggnm` 欄位（Admin 2）錯誤填入政府機構名稱：

- `세종특별자치시광역자치의회`（議會）
- `세종특별자치시청`（市廳）

若直接使用會導致 Immich 顯示「世宗 > 議會」而非「世宗 > 鳥致院邑」。

### 處理方式

本專案採用**兩階段處理機制**解決世宗的特殊結構與翻譯問題：

#### 1. 行政層級正規化

將世宗記錄的洞/邑/面從 Admin 3 提升至 Admin 2，符合其單層級結構：

- **檢測條件**：`sggnm` 不以읍/면/동結尾（排除真實行政區）
- **正規化動作**：Admin 3 → Admin 2，清空 Admin 3

**範例**：
```
處理前：世宗特別自治市 → 世宗特別自治市廳 → 대평동
處理後：世宗特別自治市 → 대평동 → (空)
```

#### 2. 手動對照表翻譯

**問題**：世宗市於 2012 年成立，多數新設洞在 Wikidata 缺少中文標籤，導致翻譯回退至羅馬拼音（`Boram-dong`）甚至韓文原文。

**解決方案**：建立涵蓋全部 24 個 Admin 2 地名的手動對照表（`core/geodata/south_korea.py` 中的 `SEJONG_ADMIN2_MAP`）。

**對照表範例**：

```python
SEJONG_ADMIN2_MAP = {
    # 8 個洞 (Dong) - Wikidata 無中文標籤
    "보람동": "寶藍洞",
    "대평동": "大坪洞",
    "다정동": "多情洞",
    "도담동": "嶋潭洞",
    "고운동": "高運洞",
    "종촌동": "鍾村洞",
    "새롬동": "新羅洞",
    "소담동": "素潭洞",

    # 3 個韓文地名 - Wikidata 無中文與英文標籤
    "어진동": "御珍洞",
    "반곡동": "盤谷洞",
    "해밀동": "海密洞",

    # 以下為可選翻譯（已可通過 Wikidata 翻譯，但直接使用對照表提升效能）
    "조치원읍": "鳥致院邑",
    "부강면": "芙江面",
    "장군면": "將軍面",
    # ... 其他地名
}
```

**翻譯流程**：

```
1. 檢測世宗特別自治市 → 2. 查詢對照表 → 3. 返回繁體中文
                                           （跳過 Wikidata）
範例：보람동 → 寶藍洞
```

**成果對比**：

| 原始韓文 | Wikidata 翻譯 | 手動對照表 |
|---------|--------------|-----------|
| 보람동 | Boram-dong ❌ | 寶藍洞 ✅ |
| 대평동 | Daepyeong-dong ❌ | 大坪洞 ✅ |
| 어진동 | 어진동 ❌ | 御珍洞 ✅ |
| 조치원읍 | 鳥致院邑 ✅ | 鳥致院邑 ✅ |

> [!NOTE]
> 經過兩階段處理後，世宗記錄的 Admin 2 會顯示洞/邑/面的繁體中文名稱（如「鳥致院邑」、「燕岐面」、「寶藍洞」），Admin 3 保持空白。這樣 Immich 就能正確顯示「世宗 > 鳥致院邑」等地理資訊。

---

## 資料來源

### 主要資料來源

**admdongkor**
- 專案：https://github.com/vuski/admdongkor
- 描述：南韓行政區邊界資料（GeoJSON 格式）
- 授權：MIT License
- 用途：提供南韓三級行政區的邊界與名稱資料

### 翻譯資料來源

**Wikidata**
- API：https://www.wikidata.org/w/api.php
- 查詢：https://query.wikidata.org/sparql
- 授權：CC0 1.0 Universal (Public Domain)
- 用途：提供多語言地名翻譯與 P131 關係驗證

**中文維基百科**
- API：https://zh.wikipedia.org/w/api.php
- 用途：簡繁轉換（converttitles API）

**OpenCC (Open Chinese Convert)**
- 專案：https://github.com/BYVoid/OpenCC
- 用途：簡體中文轉繁體中文

---

**最後更新**：2025-11-10
